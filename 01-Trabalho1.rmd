---
title: "SME0821 - Análise de Sobrevivência - Atividade I"
author: 
  - Francisco Rosa Dias de Miranda - 4402962
  - Heitor Carvalho Pinheiro - 11833351
  - Lua Nardi Quito - 11371270
  - Vitor Pinho Iecks Ponce - 10785968
  - Gusthavo
date: "abril 2022"
output: pdf_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(survival)
library(survminer)
library(knitr)
```

# 1) Introdução
Conjunto de dados utilizado

O mieloma múltiplo é o câncer que afeta aos plasmócitos, células da medula óssea responsáveis pela produção de anticorpos. Nos indivíduos acometidos, os plasmócitos são anormais e se multiplicam rapidamente, comprometendo a produção das outras células do sangue.

```{r}
df <- survminer::myeloma
```

Foram obtidos medidas de expressão gênica em indivíduos com mieloma múltiplo, a partir de bases disponíveis no GEO (Id: GSE4581), um repositório de dados genômicos públicos do NCBI (National Center for Biotechnology Information). Nesse estudo, foram coletados dados de uma amostra de 256 pacientes, consistindo nas 11 colunas descritas abaixo:


|Variável   | Descrição  |
|-----------|------------|
| `molecular_group`  | Subgrupos moleculares dos pacientes |
| `chr1q21_status`   | Status de amplificação do cromossomo 1q21 |
| `treatment`        | Todos os pacientes receberam o tratamento TT2|
| `event`            | Status de sobrevivência, 0 = vivo, 1 = morto |
| `time`            |  Tempo de sobrevivência, em meses |
| `CCND1`, `CRIM1`, | |
|`DEPDC1`, `IRF4` |    Nível de expressão dos respectivos genes|
|`TP53`,  `WHSC1` |  |


```{r}
# Conjunto de dados utilizado
df <- survminer::myeloma %>% rownames_to_column %>% tibble
df$event <- as.logical(df$event)
head(df)
```


```{r}
## trocar por tempo vs raiz quadrada da contagem
gex_cols <- c("CCND1", "CRIM1", "DEPDC1","IRF4","TP53","WHSC1")  


df %>% pivot_longer(cols = gex_cols) %>% 
ggplot(aes(y=time, x=sqrt(value))) +
  geom_point( aes(color=event), alpha=0.6) +
  facet_wrap(~name, scales = "free_x") +
  labs(x = "Raiz quadrada da contagem",
       y = "Tempo",
       color = "Censura",
       title = "Expressão gênica versus tempo de censura")
```

```{r}
## trocar por tempo vs raiz quadrada da contagem
  df %>% 
ggplot(aes(x=1:nrow(df), y=time)) +
  geom_segment( aes(x=1:nrow(df), xend=1:nrow(df), y=0, yend=time)) +
  geom_point( aes(color=event), size=4, alpha=0.6) +
  theme_light() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  )
```

# 2) Metodologia

Nesse trabalho, nosso objetivo é a análise de dados de sobrevivência com censura a direita a partir de uma abordagem não-paramétrica, em que o interesse é identificar fatores de prognóstico para o mioma múltiplo a partir da amostra coletada.


A análise de sobrevivência tem como objetivo a identificação de Neste estudo, utilizamos metodologia não paramétrica a dados  de sobrevivência em presença de censura 

# 3) Análise de dados 


 - [-] K-M
 - [ ] Atuarial 
 - [ ] Nelson-Aalen
 - [ ] Testes de hipotese


 
Inicialmente, realizaremos a estimativa da Curva de Sobrevivência dos pacientes com Mieloma, utilizando o estimador de Kaplan-Meier.

I) *K-M Algoritmo*

```{r}
km_fit <- survfit(Surv(time, event) ~ 1, data = df)
```
Definida a função de sobrevivência, podemos verificar a curva de sobrevivência considerando todas as covariáveis.

```{r}
ggsurvplot(km_fit, data = df, risk.table = FALSE)
```

Podemos verificar os resultados da estimação completa, usando `summary()`

```{r}
summary(km_fit, times = seq(0,70,5))
```

De  início, percebemos que não há tempo mediano, uma vez que as observações se encerram, antes de serem obtidas probabilidades de sobrevivência de 50%.

Sendo assim, após os pacientes em estudo, após cinco anos apresentariam uma probabilidade de sobrevivência de 60%.

### Determinando o *Cutpoint* para cada expressão gênica

Temos diferentes níveis de expressão para os genes CRIM1", "DEPDC1", "WHSC1", "CCND1", "IRF4" e "TP53".
Entretanto, a categorização desses valores nos auxilia na comparação entre as variáveis. O R nos permite estimar os *cutpoints* (Pontos de corte) idais, para cada variável numérica, permitindo reduzir os diversos valores a duas categorias: "high" e "low".

O teste utilizado é o ***Maximally Selected Rank statistics***, que assume que um valor desconhecido de *X*, determina dois grupos distintos em *Y*. No nosso, caso, o teste busca encontrar o valor númerico do nível da expressão gênica que melhor separa os valores em dois grupos distintos.

##### Determining the optimal cutpoint for each gene expression

```{r}
res.cut <- surv_cutpoint(df, time = "time", event = "event",
                         variables = c("CRIM1", "DEPDC1", "WHSC1",
                                       "CCND1", "IRF4", "TP53"),
                         progressbar = FALSE)
summary(res.cut)
```

#### Gráfico para cada "Cutpoint"

```{r}
genes <- c("CCND1", "CRIM1","DEPDC1", "IRF4", "TP53", "WHSC1")
#plotando a distribuicao de cada gene
for(gene in genes){
  print(plot(res.cut, gene, pallete = "npg"))
}
# plot(res.cut, "CRIM1", pallete = "npg")
```

Definidos os melhores pontos que dividem os valores das expressões gênicas em dois grupos distintos, podemos enfim, categorizar nossas variáveis em dois grupos: ***high*** e ***low***.


```{r}
res.cat <- surv_categorize(res.cut)
head(res.cat)
```

### Curvas de sobrevivência para cada expressão gênica

Clique [**aqui**](https://drive.google.com/uc?export=download&id=1mnjJrOtBW850p_mvFHWppaIVTqyyAucS
), para baixar o arquivo PDF com as curvas de sobrevivência para cada expressão gênica, considerando os níveis *low* e *high*.

```{r}
#defyning each fit for each gene
fit1 <- survfit(Surv(time, event) ~ CCND1, data = res.cat)
fit2 <- survfit(Surv(time, event) ~ CRIM1, data = res.cat)
fit3 <- survfit(Surv(time, event) ~ DEPDC1, data = res.cat)
fit4 <- survfit(Surv(time, event) ~ IRF4, data = res.cat)
fit5 <- survfit(Surv(time, event) ~ TP53, data = res.cat)
fit6 <- survfit(Surv(time, event) ~ WHSC1, data = res.cat)

#List of ggsurvplots

splots <- list()

splots[[1]] <- ggsurvplot(fit1, data = df, risk.table = TRUE, risk.table.height = 0.3,
                          ggtheme = theme_minimal())
splots[[2]] <- ggsurvplot(fit2, data = df, risk.table = TRUE, risk.table.height = 0.3,
                          ggtheme = theme_minimal())
splots[[3]] <- ggsurvplot(fit3, data = df, risk.table = TRUE, risk.table.height = 0.3,
                          ggtheme = theme_minimal())
splots[[4]] <- ggsurvplot(fit4, data = df, risk.table = TRUE, risk.table.height = 0.3,
                          ggtheme = theme_minimal())
splots[[5]] <- ggsurvplot(fit5, data = df, risk.table = TRUE, risk.table.height = 0.3,
                          ggtheme = theme_minimal())
splots[[6]] <- ggsurvplot(fit6, data = df, risk.table = TRUE, risk.table.height = 0.3,
                          ggtheme = theme_minimal())

 
#arrange multiple ggsurvplots  
arrange_ggsurvplots(splots, print = TRUE, 
                    ncol = 3, nrow = 2)


if (FALSE) {
# Arrange and save into pdf file
res <- arrange_ggsurvplots(splots, print = FALSE)
ggsave("myfile.pdf", res)
}
```

##### Comparando múltiplas curvas de sobrevivência para os diferentes grupos moleculares

```{r}
# Survival curves with global p-value
fit2 <- survfit(Surv(time, event) ~ molecular_group, data = df)
ggsurvplot(fit2, data = myeloma,
           legend.title = "Grupos Moleculares",
           legend.labs = levels(myeloma$molecular_group),
           legend = "right",
           pval = TRUE, palette = "lancet")
# summary(fit2)
```

O gráfico acima expõe todas as curvas de sobrevivência para os diferentes grupos moleculares. 

Em nosso teste de hipótese temos duas hipóteses possíveis:

$H_0:$ Não há diferença entre as curvas de sobrevivência para os diferentes grupos moleculares.
$H_1$ Há diferença entre as curvas de sobrevivência para os diferentes grupos moleculares.

### Curvas de Sobrevivëncia para o status da amplificação do cromossomo *chr1q21*
Em nosso teste, utilizamos por padrão um $\alpha = 0.05$, ou seja, nosso Intervalo de Confiança é de 95%. 

O valor-p resposta é um valor global que apenas nos indica se há alguma diferença entre as curvas de sobrevivência. Como $p = 0.047 < 0.05$, podemos rejeitar $H_0$ e concluir que existe uma diferença entre os grupos moleculares.

Podemos realizar um Log-rank teste pareado entre os diferentes grupos moleculares, a fim de identificar quais grupos apresentam diferenças significativas de risco de morte.

```{r}
  fit <- survfit(Surv(time, event) ~ chr1q21_status, data = df)
# Pairwise survdiff
res <- pairwise_survdiff(Surv(time, event) ~ molecular_group,
     data = myeloma)
res
```
De acordo com o teste Log-Rank entre os grupos moleculares, podemos concluir que existe diferença significativa entre os seguintes grupos moleculares:

* Proliferation e Cyclin D-2
* Proliferation e Hyperdiploid


```{r}
ggsurvplot(
   fit,                     # survfit object with calculated statistics.
   data = df,  # data used to fit survival curves. 
   risk.table = TRUE,       # show risk table.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   xlim = c(0,65),        # present narrower X axis, but not affect
                            # survival estimates.
   break.time.by = 5,     # break X axis in time intervals by 500.
   ggtheme = theme_minimal(), # customize plot and risk table with a theme.
 risk.table.y.text.col = T, # colour risk table text annotations.
  risk.table.y.text = FALSE # show bars instead of names in text annotations
                            # in legend of risk table
)
```
##### Fazer o log-rank para o grafico acima


# 4) Bibliografia


```{r}
citation("survminer")
```


# 5) Uma pasta com os dados e codigos para que o trabalho seja reproduzidos.

# 6) Os grupos apresentaram os resultados em sala de aula.

